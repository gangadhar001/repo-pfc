\subsection{Iteración 4} 

Siguiendo los casos de uso del grupo funcional \textbf{F3:} \textit{Visualización información} (ver Figura \ref{fig:CduVisualizarDecisiones2Server}), se abordan las siguientes tareas:

\begin{itemize}
	\item Análisis de los casos de uso.
	\item Diseño de la funcionalidad relativa a la visualización de información en el sistema, como son las decisiones y su información asociada.
	\item Implementación de dicha funcionalidad.
	\item Diseño e implementación de pruebas relativas a la visualización de información.
\end{itemize}

\subsubsection{Grupo funcional \textbf{F3:} \textit{Visualización información}}

\paragraph{Análisis de casos de uso}

Este grupo funcional constituye una de las funcionalidades principales del sistema, ya que se encarga de mostrar y representar todas las decisiones realizadas en un proyecto, así como su información asociada (datos del usuario que realizó la decisión, compañía a la que pertenece, etc). Por tanto, esta iteración comienza con el análisis de los casos de uso que componen dicha funcionalidad, definiendo sus escenarios y diagramas de análisis.

\subparagraph{Visualizar decisiones}

En la Tabla \ref{table:flujosConsultarDecisiones} se describe el caso de uso \textit{Visualizar decisiones}.

\begin{table}[!htbp]%
\centering
\begin{tabular}{| >{\arraybackslash}m{15cm} |}
	\hline
	\textbf{Nombre}: Visualizar decisiones \\
	\hline
	\textbf{Descripción}: Funcionalidad para visualizar las decisiones (y su información relacionada) de un proyecto. 	\\
	\hline
	\textbf{Precondiciones}: Que el usuario haya accedido al sistema y tenga permisos para realizar la operación. \\
	\hline
	\textbf{Post-condiciones}: Se consultan las decisiones de un proyecto y se visualizan. \\
	\hline 
	\textbf{Flujo principal}:
	\begin{enumerate}
	\vspace{-4mm}
	\setlength{\itemsep}{-7.5pt}
	\setlength{\parsep}{\itemsep}
	\setlength{\partopsep}{\itemsep}
	\setlength{\topsep}{-7.5pt}
	\item El usuario inicia la acción para consultar las decisiones de un proyecto.
	\item El sistema consulta las decisiones del proyecto.
	\item El sistema consulta la información asociada a las decisiones.
	\item Se muestran las decisiones encontradas.
	\item Se muestra información asociada a las decisiones.
	\vspace{-4mm}
	\end{enumerate}
	\\
	\hline
	\textbf{Flujo alternativo 1: no existen decisiones}:
	\begin{enumerate}
	\vspace{-4mm}
	\setlength{\itemsep}{-7.5pt}
	\setlength{\parsep}{\itemsep}
	\setlength{\partopsep}{\itemsep}
	\setlength{\topsep}{-7.5pt}
	\item El usuario inicia la acción para consultar las decisiones de un proyecto.
	\item El sistema consulta las decisiones del proyecto.
	\item Se muestra mensaje de que no hay ninguna decisión.
	\vspace{-4mm}
	\end{enumerate}
	\\
	\hline
\end{tabular}
\caption{Especificación del caso de uso \textit{Visualizar decisiones}}
\label{table:flujosConsultarDecisiones}
\end{table}

La Figura \ref{fig:analisisConsultarDecisionesCliente} representa el diagrama de clases de análisis para el subsistema cliente. En la Figura \ref{fig:analisisConsultarDecisionesServer} se muestra el diagrama de clases de análisis para el subsistema servidor.

\imagen{Cap5/Cliente2//analisisConsultarDecisionesCliente}{2.2}{Diagrama de clases de análisis - Cliente - Visualizar Decisiones}{fig:analisisConsultarDecisionesCliente}

\imagen{Cap5/Server2//analisisConsultarDecisionesServer}{2.2}{Diagrama de clases de análisis - Servidor - Visualizar Decisiones}{fig:analisisConsultarDecisionesServer}


\paragraph{Diseño e implementación} \label{sec:visualizarDecisiones}

En primer lugar, se modela el funcionamiento de los casos de uso que componen este grupo funcional a través de diagramas de secuencia de diseño. De este modo, en la Figura \ref{fig:secuenciaConsultarDecisionesPrincipalCliente} se muestra el diagrama de secuencia para el caso de uso \textit{Visualizar decisiones} en el cliente, mientras que la Figura \ref{fig:secuenciaLoginServer} refleja el diagrama de secuencia para el servidor. El resto de diagramas de secuencia de este grupo funcional se modelan de un modo muy similar a los diagramas mostrados.

\imagen{Cap5/Cliente2//secuenciaConsultarDecisionesPrincipalCliente}{2.5}{Diagrama de secuencia - Cliente - Consultar decisiones}{fig:secuenciaConsultarDecisionesCliente}

\imagen{Cap5/Server2//secuenciaConsultarDecisionesPrincipalServer}{1.5}{Diagrama de secuencia - Servidor - Consultar decisiones}{fig:secuenciaConsultarDecisionesServer}

Posteriormente, siguiendo los diagramas de secuencia, se realizan los diagramas de clases de diseño y se procede a la implementación de los casos de uso, para obtener las clases Java que dan soporte a estas funcionalidades. A continuación se destacan algunos aspectos tenidos en cuenta al diseñar e implementar los casos de uso que componen este grupo funcional del sistema.

\subparagraph{Servidor}

Cabe destacar que para mantener la seguridad en el sistema, siempre se comprobará en el servidor la sesión del usuario antes de realizar cualquier operación, tanto para comprobar que esa sesión existe como para validar si se tiene permiso para ejecutar dicha acción en el sistema. Por ello, los gestores (o controladores) de ésta y del resto de funcionalidades del sistema tendrán una relación con el gestor de sesiones, descrito en la segunda iteración de la fase anterior (ver Figura \ref{fig:clasesSessionController}).

Como se puede apreciar en el diagrama de clases de la Figura \ref{fig:clasesKnowledge}, las decisiones de un proyecto siguen una jerarquía de herencia, existiendo la clase abstracta \textit{Knowledge} de las que heredan otras tres clases: \textit{Topic}, \textit{Proposal} y \textit{Answer}. Se ha decidido diseñar esta herencia para facilitar la futura extensibilidad del sistema, ya que se podría incluir un nuevo tipo de conocimiento creando una nueva subclase. Además, para mejorar la organización de las decisiones, estas tres subclases están asociadas de una manera jerárquica, del siguiente modo:

\begin{itemize}
	\item \textbf{Topic} (o Tema): esta clase, que representa un Tema, está compuesta por un conjunto de decisiones del tipo \textit{Proposal} dentro de un proyecto.
	\item \textbf{Proposal} (o Propuesta): esta clase, que representa una Propuesta, esta compuesta por un conjunto de decisiones del tipo \textit{Answer}, y están agrupadas bajo un \textit{Topic} común.
	\item \textbf{Answer} (o Respuesta): esta clase, que representa una Respuesta están agrupadas bajo una \textit{Proposal} común y ya no pueden tener más hijos.
\end{itemize}


\begin{figure}[!htbp]
 \begin{center}
   \includegraphics[scale=1.78,angle=90]{Cap5/Server2//clasesKnowledge}
 \caption {Diagrama de clases - Jerarquía de decisiones}
 \label{fig:clasesKnowledge}
 \end{center}
 \end{figure}
 
%\imagen{Cap5/Server2//clasesKnowledge}{2.0}{Diagrama de clases - Jerarquía de decisiones}{fig:clasesKnowledge}


De este modo, como se muestra en la Figura \ref{fig:clasesKnowledge}, para cada proyecto, existirán una serie de \textit{Topics}, donde cada \textit{Topic} estará compuesto por una serie de \textit{Proposals} y éstas, a su vez, estarán compuestas por un conjunto de \textit{Answers}. Por tanto, se sigue una estructura de composición y jerarquía de conocimiento. Un ejemplo de esta estructura jerárquica puede encontrarse en los foros de debate presentes en la Web (ver Figura \ref{fig:foros}). 

\imagenBorde{Cap5//foros}{0.5}{Ejemplo de jerarquía de decisiones en foros de debates}{fig:foros}

Además, existe la clase \textit{TopicsWrapper}, que engloba todos los \textit{Topic} de un proyecto, facilitando su recuperación y necesario además para exportar todo el conocimiento a un fichero XML, como se detallará en el posterior apartado \ref{sec:exportarConocimiento}.

Esta jerarquía de decisiones, junto con toda su información y clases relacionadas, se considera como uno de los puntos de más importancia del presente PFC, ya que muchas del resto de funcionalidad del sistema giran en torno a las decisiones tomadas en los proyectos y a su información relacionada y utilizan las relaciones y jerarquía diseñadas en este punto para cumplir con su objetivo.

Siguiendo esta estructura descrita, en lo que respecta al caso de uso \textit{Visualizar Decisiones}, se recupera y visualiza esta composición jerárquica de decisiones y toda su información asociada, como es el usuario, la compañía y los posibles ficheros adjuntos (ver diagrama de la Figura \ref{fig:clasesKnowledge}). Sin embargo, al utilizar el framework de persistencia \textit{Hibernate}, no hace falta hacer varias consultas para recuperar toda esta información, como se muestra en el diagrama de secuencia de la Figura \ref{fig:secuenciaConsultarDecisionesServer}, ya que al existir asociaciones entre los objetos, Hibernate se encargará de recuperar todos ellos al consultar las decisiones existentes en un proyecto.

En lo que concierne al caso de uso \textit{Visualizar Compañía}, que sirve para consultar y mostrar los detalles de una compañía, cabe destacar como aspecto de implementación que se ha utilizado un servicio Web para obtener la posición geográfica de la dirección de la compañía, para poder mostrarla posteriormente en un mapa, en el subsistema cliente. Para ello, como se vió en el marco tecnológico de la sección \ref{sec:marco}, se ha utilizado el servicio web \textbf{Yahoo! PlaceFinder} para obtener las coordenadas geográficas a partir de una dirección.

En un primer momento se pensó en utilizar el API de geolocalización de Google para realizar esta tarea. Sin embargo, atendiendo a las condiciones de uso de Google \cite{condicionesGoogle}, esta API debe usarse en conjunto con el API de \textit{Google Maps}, que a su vez sólo se puede utilizar en aplicaciones Web. Por tanto, se descartó esta opción para no violar las condiciones de uso de Google y se buscó una alternativa, encontrando el servicio web de Yahoo!, cuyos términos de uso permitían utilizarlo en el sistema \cite{condicionesYahoo}. 

Para invocar el servicio \textit{Yahoo! PlaceFinder}, se necesita una URL del tipo: {\footnotesize{\begin{verbatim}http://where.yahooapis.com/geocode?[parameters]&appid=APPID \end{verbatim}}} donde \textit{APPID} es un código proporcionado para desarrolladores para poder utilizar su API, y \textit{parameters} es la dirección a buscar. 

Un ejemplo de URL sería: {\footnotesize{\begin{verbatim}http://where.yahooapis.com/geocode?location=701+First+Sunnyvale&APPID\end{verbatim}}} Al invocar el servicio web, éste devuelve una respuesta en formato XML indicando una serie de parámetros, como se muestra en el Listado \ref{list:Yahoo}. Entre ellos, interesa el código de error y las coordenadas geográficas de la dirección, formadas por longitud y latitud.

\texttt{\lstinputlisting[caption=Respuesta del servicio Web Yahoo! PlaceFinder, label=list:Yahoo, breaklines=true, inputencoding=latin1, style=XMLStyle]{Codigo//RespuestaYDN.xml}}

En el Listado \ref{list:GeoCoder} se muestra un fragmento de código utilizado para invocar el servicio web desde Java y obtener su respuesta XML, que será tratada con JDOM para extraer los datos necesarios (las coordenadas) para poder mostrar en un mapa la posición exacta de la compañía.

\texttt{\lstinputlisting[caption=Invocación del servicio Web Yahoo! PlaceFinder, breaklines=true, label=list:GeoCoder, inputencoding=latin1, style=JavaStyle]{Codigo//GeoCoder.java}}


\subparagraph{Cliente}

En el subsistema cliente, cuando se consultan las decisiones, éstas se muestran de manera jerárquica (en árbol) y en forma de grafo, utilizando \textbf{JUNG} (ver sección \ref{sec:marco}). Se ha decidido utilizar ambos tipos de visualización para ofrecer una mayor flexibilidad e información al usuario, ya que gracias a la representación jerárquica, se puede apreciar toda la estructura de decisiones de un simple vistazo, mientras que con el grafo, se pueden observar cómo están asociadas dichas decisiones, mostrándose de manera mas detallada, siguiendo el modo de representación de \textit{Rationale} llamado \textbf{Dialogue Map}, mencionado en la sección \ref{sec:rationale}. Además de mostrar las decisiones, también se muestra toda su información asociada, utilizando paneles expandibles, para flexibilizar y personalizar la información que en cada momento el usuario quiere mostrar.  

Un tipo de información que se muestra para cada decisión son los archivos adjuntos que tiene, que pueden ser descargados por el usuario, guardando una copia local que envía el sistema servidor al hacer la petición.

%% PROTOTIPO


Para terminar, en lo que se refiere al caso de uso de \textit{Visualizar compañía}, se ha decidido mostrar en un mapa la posición geográfica (además de otros datos) de la compañía consultada, para poder conocer su información exacta y real. Para ello se han utilizado los mapas proporcionados por \textbf{OpenStreetMaps} (ver sección \ref{sec:marco}), ya que, como se comentó anteriormente, debido a los términos de uso de Google, los mapas proporcionados por \textit{Google Maps} sólo pueden utilizarse en aplicaciones Web, por lo que se decidió optar por esta alternativa.

Para mostrar los mapas proporcionados por \textit{OpenStreetMaps}, se ha utilizado un contenedor gráfico llamado \textbf{JXMapKit}, proporcionado por la librería \textit{Swingx}, el cuál puede ser configurado para proporcionarle un proveedor de mapas para visualizar. Además, una vez calculadas las coordenadas geográficas en el sistema servidor, este elemento permite añadir un marcador, llamado \textit{WayPointer} para marcar exactamente esas coordenadas, correspondientes a la posición real de la compañía. En el fragmento de código \ref{list:JXMap} se muestra esta implementación y uso de \textit{JXMapKit}.

\texttt{\lstinputlisting[caption=Fragmento de código para mostrar mapas geoposicionados, breaklines=true, label=list:JXMap, inputencoding=latin1, style=JavaStyle]{Codigo//GeoMap.java}}



\paragraph{Pruebas}