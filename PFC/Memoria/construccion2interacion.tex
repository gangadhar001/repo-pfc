\subsection{Segunda iteración} 

Durante esta iteración, se diseñan, implementan y prueban los casos de uso que componen la funcionalidad de \textit{Gestión de decisiones}, mostrados en la Figura \ref{fig:CduGestionDecisiones2Server}, y la funcionalidad de \textit{Gestión de notificaciones} (ver Figura \ref{fig:CduGestionNotificaciones2Server}).

\subsubsection{Funcionalidad de \textit{Gestión de decisiones}}

\paragraph{Diagramas de secuencia}

En los siguientes apartados se muestran los diagramas de secuencia para el cliente y servidor de los casos de uso que componen esta funcionalidad. Dichos diagramas se modelan siguiendo la descripción de los casos de uso realizada en el apartado \ref{sec:analisis}.

\subparagraph{Crear decisión}

En las Figuras \ref{fig:secuenciaCrearTopicCliente}, \ref{fig:secuenciaCrearProposalCliente} y \ref{fig:secuenciaCrearAnswerCliente} se muestran los diagramas de secuencia para el caso de uso \textit{Crear decisión} en el subsistema cliente, mientras que en la Figura \ref{fig:secuenciaCrearDecisionServer} se muestra el diagrama de secuencia para el servidor. Señalar que en el caso del subsistema cliente, se han creado tres diagramas de secuencia, para representar los diferentes actores (o roles en el sistema) que participan en el caso de uso \textit{crear decisión}, según el tipo de decisión. En el servidor, sin embargo, no es necesario separarlo, ya que la secuencia de acciones a realizar es la misma, independientemente del tipo de decisión creada.

\imagen{Cap5/Cliente2//secuenciaCrearTopicCliente}{0.6}{Diagrama de secuencia - Cliente - Crear decisión (\textit{Topic})}{fig:secuenciaCrearTopicCliente}

\imagen{Cap5/Cliente2//secuenciaCrearProposalCliente}{0.6}{Diagrama de secuencia - Cliente - Crear decisión (\textit{Topic})}{fig:secuenciaCrearProposalCliente}

\imagen{Cap5/Cliente2//secuenciaCrearAnswerCliente}{0.6}{Diagrama de secuencia - Cliente - Crear decisión (\textit{Topic})}{fig:secuenciaCrearAnswerCliente}

\imagen{Cap5/Server2//secuenciaCrearDecisionServer}{2.0}{Diagrama de secuencia - Servidor - Crear decisión}{fig:secuenciaCrearDecisionServer}


\subparagraph{Modificar y eliminar decisión}

Los diagramas de secuencia de estos dos casos de uso, para el subsistema cliente y servidor, son iguales que en caso de uso anterior, sólo que la acción realizada es modificar o eliminar una decisión, en vez de crearla. 


\subparagraph{Aceptar decisiones}

En la Figura \ref{fig:secuenciaAceptarDecisionesCliente} se muestra el diagrama de secuencia para el caso de uso \textit{Aceptar decisiones} en el cliente, mientras que en la Figura \ref{fig:secuenciaAceptarDecisionesServer} se muestra el diagrama de secuencia para el servidor.

%\imagen{Cap5/Cliente2//secuenciaAceptarDecisionesCliente}{1.0}{Diagrama de secuencia - Cliente - Aceptar decisión}{fig:secuenciaAceptarDecisionesCliente}

%\imagen{Cap5/Server2//secuenciaAceptarDecisionesServer}{1.0}{Diagrama de secuencia - Servidor - Aceptar decisión}{fig:secuenciaAceptarDecisionesServer}


\subparagraph{Adjuntar ficheros}

En la Figura \ref{fig:secuenciaAdjuntarFicherosCliente} se muestra el diagrama de secuencia para el caso de uso \textit{Adjuntar ficheros} en el cliente, mientras que en la Figura \ref{fig:secuenciaAdjuntarFicherosServer} se muestra el diagrama de secuencia para el servidor.

\imagen{Cap5/Cliente2//secuenciaAdjuntarFicherosCliente}{1.0}{Diagrama de secuencia - Cliente - Adjuntar ficheros}{fig:secuenciaAdjuntarFicherosCliente}

\imagen{Cap5/Server2//secuenciaAdjuntarFicherosServer}{1.0}{Diagrama de secuencia - Servidor - Adjuntar ficheros}{fig:secuenciaAdjuntarFicherosServer}



\paragraph{Diseño e implementación}

\subparagraph{Servidor}

En el diseño e implementación de estos casos de uso, cabe destacar la creación de una alerta o notificación de manera automática por parte del servidor al realizar cualquier acción sobre las decisiones. Dicha alerta se crea para el proyecto en el cuál se ha creado, modificado o eliminado una decisión, y para todos los usuarios que en dicho proyecto participan. De este modo, se notifica a los empleados que trabajan en ese proyecto que nuevo conocimiento está disponible, indicando en la alerta el tipo de decisión afectada, su autor, fecha y otros detalles. Esto facilita la comunicación asíncrona, ya que cuando un usuario vuelva a iniciar sesión, podrá comprobar sus nuevas alertas y adquirir conciencia de los cambios y nuevo conocimiento disponible o modificado.

En la Figura \ref{fig:clasesGestionDecisiones} se muestra el diagrama de clases para la funcionalidad de gestión de decisiones, mostrando las asociaciones entre clases y entre los controladores de decisiones y de notificaciones.

\imagen{Cap5/Server2//clasesGestionDecisiones}{2.0}{Diagrama de clases - Gestión de decisiones}{fig:clasesGestionDecisiones}


Como en el resto de casos, las operaciones de bases de datos se delegan en el gestor de bases de datos y éste, a su vez, delega en el framework \textbf{Hibernate}.

También cabe destacar otra decisión de diseño que se ha tenido en cuenta para implementar otro de los requisitos del sistema, que es la comunicación síncrona. Para ello, cuando un cliente crea, modifica o elimina una decisión y envía la petición al servidor, éste, además de crear la alerta, notifica a los clientes conectados que se ha producido un cambio, para que éstos puedan actualizar su vista de la interfaz gráfica y puedan reflejar los cambios sobre esa decisión en tiempo real. Para ello, el servidor lanza un hilo por cada uno de los clientes registrados en el sistema y les envía la información necesaria. Se utilizan hilos para no bloquear el servidor mientras manda actualizaciones a los clientes y pueda seguir atendiendo otras peticiones. 

La clase controlador encargada de realizar esta tarea constituye además un patrón \textbf{observador}, el cuál se utiliza para registrar los clientes autenticados en el sistema y notificar y actualizar su estado. En el diagrama de la Figura \ref{fig:clasesObservadorClientes} se muestra este patrón y las clases que lo forman.


\imagen{Cap5/Server2//clasesObservadorClientes}{2.0}{Diagrama de clases - Observador para actualizar clientes conectados}{fig:clasesObservadorClientes}


En el fragmento de código \ref{list:observador} se muestra parte de la implementación de la clase controlador de los clientes, y en el fragmento \ref{list:hilos} como se ha implementado la gestión de hilos para notificar a los clientes. La clase encargada de esto último además representa un patrón \textbf{proxy}, ya que los clientes son remotos.

\texttt{\lstinputlisting[caption=Fragmento de código del controlador de clientes, breaklines=true, label=list:observador, inputencoding=latin1, style=JavaStyle]{Codigo//observadorClientes.java}}

\texttt{\lstinputlisting[caption=Soporte multi-hilo para actualizar el estado de clientes, breaklines=true, label=list:hilos, inputencoding=latin1, style=JavaStyle]{Codigo//hilos.java}}



\subparagraph{Cliente}



\subsubsection{Funcionalidad de \textit{Gestión de notificaciones}}

\paragraph{Diagramas de secuencia}

\subparagraph{Consultar notificaciones}

En la Figura \ref{fig:secuenciaConsultarNotificacionCliente} se muestra el diagrama de secuencia para el caso de uso \textit{Consultar notificaciones} en el cliente, mientras que en la Figura \ref{fig:secuenciaConsultarNotificacionServer} se muestra el diagrama de secuencia para el servidor.

\imagen{Cap5/Cliente2//secuenciaConsultarNotificacionCliente}{1.0}{Diagrama de secuencia - Cliente - Consultar notificaciones}{fig:secuenciaConsultarNotificacionCliente}

\imagen{Cap5/Server2//secuenciaConsultarNotificacionServer}{1.0}{Diagrama de secuencia - Servidor - Consultar notificaciones}{fig:secuenciaConsultarNotificacionServer}